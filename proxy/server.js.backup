const express = require('express');
const cors = require('cors');
const fetch = require('node-fetch');
const path = require('path');
require('dotenv').config();

const app = express();
app.use(cors());
app.use(express.json());

// æä¾›é™æ€æ–‡ä»¶
app.use(express.static(path.join(__dirname, '../dist')));

const PORT = process.env.PORT || 3001;
const MINIMAX_API_KEY = process.env.MINIMAX_API_KEY;

// TTS ä»£ç†æ¥å£ - ä¿®æ­£ç‰ˆ (MiniMax API v2)
app.post('/api/tts', async (req, res) => {
  if (!MINIMAX_API_KEY) {
    return res.status(500).json({ 
      error: 'MINIMAX_API_KEY not configured',
      message: 'è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® MINIMAX_API_KEY'
    });
  }

  const { text, voice_id = 'male-qn-qingse', speed = 0.8 } = req.body;
  
  if (!text) {
    return res.status(400).json({ error: 'text is required' });
  }

  try {
    const response = await fetch('https://api.minimaxi.chat/v1/t2a_v2', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${MINIMAX_API_KEY}`
      },
      body: JSON.stringify({
        model: 'speech-01-turbo',
        text: text,
        voice_setting: {
          voice_id: voice_id,
          speed: speed,
          vol: 1.0
        },
        audio_setting: {
          sample_rate: 32000,
          bitrate: 128000,
          format: 'mp3'
        }
      })
    });

    const data = await response.json();
    
    // æ£€æŸ¥ API è¿”å›çŠ¶æ€
    if (data.base_resp?.status_code !== 0) {
      return res.status(400).json({
        success: false,
        error: data.base_resp?.status_msg || 'API Error',
        code: data.base_resp?.status_code
      });
    }
    
    // å¤„ç†éŸ³é¢‘æ•°æ®
    if (data.data?.audio) {
      // MiniMax è¿”å›çš„æ˜¯åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œéœ€è¦è½¬æ¢ä¸º base64
      const hexString = data.data.audio;
      const buffer = Buffer.from(hexString, 'hex');
      const base64Audio = buffer.toString('base64');
      
      // è®°å½•ä½¿ç”¨é‡
      const usage = data.extra_info || {};
      console.log(`ğŸ™ï¸ TTS è¯·æ±‚: "${text.substring(0, 30)}${text.length > 30 ? '...' : ''}"`);
      console.log(`   ğŸ“Š å­—ç¬¦æ•°: ${usage.usage_characters || 'N/A'} | éŸ³é¢‘æ—¶é•¿: ${usage.audio_length}ms | æ–‡ä»¶å¤§å°: ${usage.audio_size} bytes`);
      
      return res.json({
        success: true,
        audio_base64: base64Audio,
        format: 'mp3',
        extra_info: data.extra_info
      });
    }
    
    return res.status(400).json({
      success: false,
      error: 'No audio data received'
    });
    
  } catch (error) {
    console.error('TTS Error:', error);
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// å¥åº·æ£€æŸ¥
app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'ok',
    tts_configured: !!MINIMAX_API_KEY
  });
});

app.listen(PORT, () => {
  console.log(`ğŸš€ MiniMax TTS Proxy + é™æ€æ–‡ä»¶æœåŠ¡å™¨ running on http://localhost:${PORT}`);
  console.log(`ğŸ¨ æ‰“å¼€ http://localhost:${PORT} æŸ¥çœ‹åº”ç”¨`);
  console.log(`ğŸ”‘ API Key configured: ${MINIMAX_API_KEY ? 'Yes' : 'No'}`);
});
